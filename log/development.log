  [1m[35m (117.1ms)[0m  [1m[35mCREATE DATABASE "causality_development" ENCODING = 'unicode' /*application='Causality'*/[0m
  [1m[35mSQL (0.4ms)[0m  [1m[35mSET search_path TO public /*application='Causality'*/[0m
  [1m[35m (203.0ms)[0m  [1m[35mCREATE DATABASE "causality_development" ENCODING = 'unicode' /*application='Causality'*/[0m
  [1m[35mSQL (0.5ms)[0m  [1m[35mSET search_path TO public /*application='Causality'*/[0m
  [1m[35m (92.5ms)[0m  [1m[35mCREATE DATABASE "causality_test" ENCODING = 'unicode' /*application='Causality'*/[0m
  [1m[35m (7.5ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" character varying NOT NULL PRIMARY KEY) /*application='Causality'*/[0m
  [1m[35m (7.5ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" character varying NOT NULL PRIMARY KEY, "value" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL) /*application='Causality'*/[0m
  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_try_advisory_lock(121933364963376015) /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.6ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Create (0.8ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'development', '2025-05-24 22:56:34.843186', '2025-05-24 22:56:34.843188') RETURNING "key" /*application='Causality'*/[0m
Migrating to CreateInitialSchema (20250524225229)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN /*application='Causality'*/[0m
  [1m[35m (46.3ms)[0m  [1m[35m      CREATE TYPE phase_enum AS ENUM (
        'declared',
        'reacted_to',
        'started',
        'resolved',
        'failed'
      );

      CREATE TYPE resolution_timing_enum AS ENUM (
        'before',
        'after'
      );

      CREATE TYPE location_enum AS ENUM (
        'deck',
        'hand',
        'discard',
        'table'
      );

      CREATE TABLE templates (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        name varchar NOT NULL,
        description text NOT NULL,
        resolution_timing resolution_timing_enum NOT NULL,
        is_free boolean DEFAULT false NOT NULL,
        declarability_key varchar NOT NULL,
        tick_condition_key varchar NOT NULL,
        tick_effect_key varchar NOT NULL,
        max_tick_count integer NOT NULL,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE UNIQUE INDEX index_templates_on_name ON templates (name);

      CREATE TABLE games (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        current_character_id bigint,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );

      CREATE TABLE characters (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        game_id bigint NOT NULL REFERENCES games(id) ON DELETE CASCADE,
        name varchar NOT NULL,
        health integer DEFAULT 100 NOT NULL,
        actions_remaining integer DEFAULT 2 NOT NULL,
        reactions_remaining integer DEFAULT 2 NOT NULL,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_characters_on_game_id ON characters (game_id);

      ALTER TABLE games ADD CONSTRAINT fk_games_current_character_id FOREIGN KEY (current_character_id) REFERENCES characters(id) ON DELETE RESTRICT;

      CREATE TABLE cards (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        owner_character_id bigint NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
        template_id bigint NOT NULL REFERENCES templates(id) ON DELETE RESTRICT,
        location location_enum NOT NULL DEFAULT 'deck',
        position integer NOT NULL DEFAULT 0,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_cards_on_owner_character_id ON cards (owner_character_id);
      CREATE INDEX index_cards_on_template_id ON cards (template_id);
      CREATE UNIQUE INDEX index_cards_on_owner_character_id_location_position_unique ON cards (owner_character_id, location, position);

      CREATE TABLE actions (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        game_id bigint NOT NULL REFERENCES games(id) ON DELETE CASCADE,
        card_id bigint NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
        source_id bigint NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
        trigger_id bigint REFERENCES actions(id) ON DELETE SET NULL,
        phase phase_enum DEFAULT 'declared' NOT NULL,
        resolution_timing resolution_timing_enum,
        is_free boolean DEFAULT false NOT NULL,
        declarability_key varchar NOT NULL,
        tick_condition_key varchar NOT NULL,
        tick_effect_key varchar NOT NULL,
        max_tick_count integer NOT NULL,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_actions_on_game_id ON actions (game_id);
      CREATE INDEX index_actions_on_card_id ON actions (card_id);
      CREATE INDEX index_actions_on_source_id ON actions (source_id);
      CREATE INDEX index_actions_on_trigger_id ON actions (trigger_id);
      CREATE INDEX index_actions_on_phase ON actions (phase);
      CREATE INDEX index_actions_on_game_id_phase ON actions (game_id, phase);

      CREATE TABLE action_targets (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        action_id bigint NOT NULL REFERENCES actions(id) ON DELETE CASCADE,
        target_character_id bigint NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_action_targets_on_action_id ON action_targets (action_id);
      CREATE INDEX index_action_targets_on_target_character_id ON action_targets (target_character_id);
 /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Create (1.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20250524225229') RETURNING "version" /*application='Causality'*/[0m
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mCOMMIT /*application='Causality'*/[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(121933364963376015) /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(121933364963376015) /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
Migrating to CreateInitialSchema (20250524225229)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN /*application='Causality'*/[0m
  [1m[35m (13.1ms)[0m  [1m[35m      DROP TABLE IF EXISTS action_targets CASCADE;
      DROP TABLE IF EXISTS actions CASCADE;
      DROP TABLE IF EXISTS cards CASCADE;
      -- Need to remove the FK constraint on games before dropping characters
      ALTER TABLE games DROP CONSTRAINT IF EXISTS fk_games_current_character_id;
      DROP TABLE IF EXISTS characters CASCADE;
      DROP TABLE IF EXISTS games CASCADE;
      DROP TABLE IF EXISTS templates CASCADE;

      DROP TYPE IF EXISTS location_enum;
      DROP TYPE IF EXISTS resolution_timing_enum;
      DROP TYPE IF EXISTS phase_enum;
 /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Destroy (2.0ms)[0m  [1m[31mDELETE FROM "schema_migrations" WHERE "schema_migrations"."version" = '20250524225229' /*application='Causality'*/[0m
  [1m[36mTRANSACTION (1.4ms)[0m  [1m[35mCOMMIT /*application='Causality'*/[0m
  [1m[35m (0.1ms)[0m  [1m[34mSELECT pg_advisory_unlock(121933364963376015) /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[35m (0.5ms)[0m  [1m[34mSELECT pg_try_advisory_lock(121933364963376015) /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.4ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
Migrating to CreateInitialSchema (20250524225229)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN /*application='Causality'*/[0m
  [1m[35m (39.4ms)[0m  [1m[35m      CREATE TYPE phase_enum AS ENUM (
        'declared',
        'reacted_to',
        'started',
        'resolved',
        'failed'
      );

      CREATE TYPE resolution_timing_enum AS ENUM (
        'before',
        'after'
      );

      CREATE TYPE location_enum AS ENUM (
        'deck',
        'hand',
        'discard',
        'table'
      );

      CREATE TABLE templates (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        name varchar NOT NULL,
        description text NOT NULL,
        resolution_timing resolution_timing_enum NOT NULL,
        is_free boolean DEFAULT false NOT NULL,
        declarability_key varchar NOT NULL,
        tick_condition_key varchar NOT NULL,
        tick_effect_key varchar NOT NULL,
        max_tick_count integer NOT NULL,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE UNIQUE INDEX index_templates_on_name ON templates (name);

      CREATE TABLE games (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        current_character_id bigint,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );

      CREATE TABLE characters (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        game_id bigint NOT NULL REFERENCES games(id) ON DELETE CASCADE,
        name varchar NOT NULL,
        health integer DEFAULT 100 NOT NULL,
        actions_remaining integer DEFAULT 2 NOT NULL,
        reactions_remaining integer DEFAULT 2 NOT NULL,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_characters_on_game_id ON characters (game_id);

      ALTER TABLE games ADD CONSTRAINT fk_games_current_character_id FOREIGN KEY (current_character_id) REFERENCES characters(id) ON DELETE RESTRICT;

      CREATE TABLE cards (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        owner_character_id bigint NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
        template_id bigint NOT NULL REFERENCES templates(id) ON DELETE RESTRICT,
        location location_enum NOT NULL DEFAULT 'deck',
        position integer NOT NULL DEFAULT 0,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_cards_on_owner_character_id ON cards (owner_character_id);
      CREATE INDEX index_cards_on_template_id ON cards (template_id);
      CREATE UNIQUE INDEX index_cards_on_owner_character_id_location_position_unique ON cards (owner_character_id, location, position);

      CREATE TABLE actions (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        game_id bigint NOT NULL REFERENCES games(id) ON DELETE CASCADE,
        card_id bigint NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
        source_id bigint NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
        trigger_id bigint REFERENCES actions(id) ON DELETE SET NULL,
        phase phase_enum DEFAULT 'declared' NOT NULL,
        resolution_timing resolution_timing_enum,
        is_free boolean DEFAULT false NOT NULL,
        declarability_key varchar NOT NULL,
        tick_condition_key varchar NOT NULL,
        tick_effect_key varchar NOT NULL,
        max_tick_count integer NOT NULL,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_actions_on_game_id ON actions (game_id);
      CREATE INDEX index_actions_on_card_id ON actions (card_id);
      CREATE INDEX index_actions_on_source_id ON actions (source_id);
      CREATE INDEX index_actions_on_trigger_id ON actions (trigger_id);
      CREATE INDEX index_actions_on_phase ON actions (phase);
      CREATE INDEX index_actions_on_game_id_phase ON actions (game_id, phase);

      CREATE TABLE action_targets (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        action_id bigint NOT NULL REFERENCES actions(id) ON DELETE CASCADE,
        target_character_id bigint NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_action_targets_on_action_id ON action_targets (action_id);
      CREATE INDEX index_action_targets_on_target_character_id ON action_targets (target_character_id);
 /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20250524225229') RETURNING "version" /*application='Causality'*/[0m
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT /*application='Causality'*/[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(121933364963376015) /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[35mSQL (0.1ms)[0m  [1m[35mSET search_path TO public /*application='Causality'*/[0m
  [1m[35m (40.9ms)[0m  [1m[35mDROP DATABASE IF EXISTS "causality_development" /*application='Causality'*/[0m
  [1m[35mSQL (1.0ms)[0m  [1m[35mSET search_path TO public /*application='Causality'*/[0m
  [1m[35m (36.2ms)[0m  [1m[35mDROP DATABASE IF EXISTS "causality_test" /*application='Causality'*/[0m
  [1m[35mSQL (0.0ms)[0m  [1m[35mSET search_path TO public /*application='Causality'*/[0m
  [1m[35m (66.7ms)[0m  [1m[35mCREATE DATABASE "causality_development" ENCODING = 'unicode' /*application='Causality'*/[0m
  [1m[35mSQL (0.1ms)[0m  [1m[35mSET search_path TO public /*application='Causality'*/[0m
  [1m[35m (68.6ms)[0m  [1m[35mCREATE DATABASE "causality_test" ENCODING = 'unicode' /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Create (1.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'development', '2025-05-24 23:44:23.307420', '2025-05-24 23:44:23.307423') RETURNING "key" /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'schema_sha1' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Create (0.8ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('schema_sha1', '917b33bc1bb3a395219137ab6c79b52b024a4894', '2025-05-24 23:44:23.313692', '2025-05-24 23:44:23.313693') RETURNING "key" /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.5ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Create (0.7ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2025-05-24 23:44:23.438878', '2025-05-24 23:44:23.439168') RETURNING "key" /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'schema_sha1' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Create (1.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('schema_sha1', '917b33bc1bb3a395219137ab6c79b52b024a4894', '2025-05-24 23:44:23.442715', '2025-05-24 23:44:23.442716') RETURNING "key" /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[35m (0.5ms)[0m  [1m[34mSELECT pg_try_advisory_lock(121933364963376015) /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
Migrating to CreateInitialSchema (20250524225229)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN /*application='Causality'*/[0m
  [1m[35m (6.0ms)[0m  [1m[35m      DROP TABLE IF EXISTS action_targets CASCADE;
      DROP TABLE IF EXISTS actions CASCADE;
      DROP TABLE IF EXISTS cards CASCADE;
      -- Need to remove the FK constraint on games before dropping characters
      ALTER TABLE games DROP CONSTRAINT IF EXISTS fk_games_current_character_id;
      DROP TABLE IF EXISTS characters CASCADE;
      DROP TABLE IF EXISTS games CASCADE;
      DROP TABLE IF EXISTS templates CASCADE;

      DROP TYPE IF EXISTS location_enum;
      DROP TYPE IF EXISTS resolution_timing_enum;
      DROP TYPE IF EXISTS phase_enum;
 /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Destroy (0.2ms)[0m  [1m[31mDELETE FROM "schema_migrations" WHERE "schema_migrations"."version" = '20250524225229' /*application='Causality'*/[0m
  [1m[36mTRANSACTION (1.7ms)[0m  [1m[35mCOMMIT /*application='Causality'*/[0m
  [1m[35m (0.1ms)[0m  [1m[34mSELECT pg_advisory_unlock(121933364963376015) /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[35m (0.5ms)[0m  [1m[34mSELECT pg_try_advisory_lock(121933364963376015) /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
Migrating to CreateInitialSchema (20250524225229)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN /*application='Causality'*/[0m
  [1m[35m (46.0ms)[0m  [1m[35m      CREATE TYPE phase_enum AS ENUM (
        'declared',
        'reacted_to',
        'started',
        'resolved',
        'failed'
      );

      CREATE TYPE resolution_timing_enum AS ENUM (
        'before',
        'after'
      );

      CREATE TYPE location_enum AS ENUM (
        'deck',
        'hand',
        'discard',
        'table'
      );

      CREATE TABLE templates (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        name varchar NOT NULL,
        description text NOT NULL,
        resolution_timing resolution_timing_enum NOT NULL,
        is_free boolean DEFAULT false NOT NULL,
        declarability_key varchar NOT NULL,
        tick_condition_key varchar NOT NULL,
        tick_effect_key varchar NOT NULL,
        max_tick_count integer NOT NULL,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE UNIQUE INDEX index_templates_on_name ON templates (name);

      CREATE TABLE games (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        current_character_id bigint,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );

      CREATE TABLE characters (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        game_id bigint NOT NULL REFERENCES games(id) ON DELETE CASCADE,
        name varchar NOT NULL,
        health integer DEFAULT 100 NOT NULL,
        actions_remaining integer DEFAULT 2 NOT NULL,
        reactions_remaining integer DEFAULT 2 NOT NULL,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_characters_on_game_id ON characters (game_id);

      ALTER TABLE games ADD CONSTRAINT fk_games_current_character_id FOREIGN KEY (current_character_id) REFERENCES characters(id) ON DELETE RESTRICT;

      CREATE TABLE cards (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        owner_character_id bigint NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
        template_id bigint NOT NULL REFERENCES templates(id) ON DELETE RESTRICT,
        location location_enum NOT NULL DEFAULT 'deck',
        position integer NOT NULL DEFAULT 0,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_cards_on_owner_character_id ON cards (owner_character_id);
      CREATE INDEX index_cards_on_template_id ON cards (template_id);

      CREATE TABLE actions (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        game_id bigint NOT NULL REFERENCES games(id) ON DELETE CASCADE,
        card_id bigint NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
        source_id bigint NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
        trigger_id bigint REFERENCES actions(id) ON DELETE SET NULL,
        phase phase_enum DEFAULT 'declared' NOT NULL,
        resolution_timing resolution_timing_enum,
        is_free boolean DEFAULT false NOT NULL,
        declarability_key varchar NOT NULL,
        tick_condition_key varchar NOT NULL,
        tick_effect_key varchar NOT NULL,
        max_tick_count integer NOT NULL,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_actions_on_game_id ON actions (game_id);
      CREATE INDEX index_actions_on_card_id ON actions (card_id);
      CREATE INDEX index_actions_on_source_id ON actions (source_id);
      CREATE INDEX index_actions_on_trigger_id ON actions (trigger_id);
      CREATE INDEX index_actions_on_phase ON actions (phase);
      CREATE INDEX index_actions_on_game_id_phase ON actions (game_id, phase);

      CREATE TABLE action_targets (
        id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
        action_id bigint NOT NULL REFERENCES actions(id) ON DELETE CASCADE,
        target_character_id bigint NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
        created_at timestamp(6) without time zone NOT NULL DEFAULT NOW(),
        updated_at timestamp(6) without time zone NOT NULL DEFAULT NOW()
      );
      CREATE INDEX index_action_targets_on_action_id ON action_targets (action_id);
      CREATE INDEX index_action_targets_on_target_character_id ON action_targets (target_character_id);
 /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20250524225229') RETURNING "version" /*application='Causality'*/[0m
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT /*application='Causality'*/[0m
  [1m[35m (0.1ms)[0m  [1m[34mSELECT pg_advisory_unlock(121933364963376015) /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.4ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[35mSQL (0.1ms)[0m  [1m[35mSET search_path TO public /*application='Causality'*/[0m
  [1m[35m (41.8ms)[0m  [1m[35mDROP DATABASE IF EXISTS "causality_development" /*application='Causality'*/[0m
  [1m[35mSQL (0.9ms)[0m  [1m[35mSET search_path TO public /*application='Causality'*/[0m
  [1m[35m (33.3ms)[0m  [1m[35mDROP DATABASE IF EXISTS "causality_test" /*application='Causality'*/[0m
  [1m[35mSQL (0.1ms)[0m  [1m[35mSET search_path TO public /*application='Causality'*/[0m
  [1m[35m (73.2ms)[0m  [1m[35mCREATE DATABASE "causality_development" ENCODING = 'unicode' /*application='Causality'*/[0m
  [1m[35mSQL (0.1ms)[0m  [1m[35mSET search_path TO public /*application='Causality'*/[0m
  [1m[35m (65.5ms)[0m  [1m[35mCREATE DATABASE "causality_test" ENCODING = 'unicode' /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Create (0.8ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'development', '2025-05-25 00:04:53.778186', '2025-05-25 00:04:53.778189') RETURNING "key" /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'schema_sha1' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Create (0.6ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('schema_sha1', '6b25c5c5648502fb82229db4ab15e05e95b39834', '2025-05-25 00:04:53.786249', '2025-05-25 00:04:53.786250') RETURNING "key" /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'environment' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Create (1.2ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2025-05-25 00:04:53.920972', '2025-05-25 00:04:53.921312') RETURNING "key" /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = 'schema_sha1' ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1 /*application='Causality'*/[0m
  [1m[36mActiveRecord::InternalMetadata Create (0.8ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('schema_sha1', '6b25c5c5648502fb82229db4ab15e05e95b39834', '2025-05-25 00:04:53.927348', '2025-05-25 00:04:53.927349') RETURNING "key" /*application='Causality'*/[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='Causality'*/[0m
